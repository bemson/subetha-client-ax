/* SubEtha Ad Hoc-Exchange v0.0.1-alpha | github.com/bemson | (c) 2014, APACHE */
!function(t,u,y,v,A){function k(){function k(a,b,d){var c,e=b[0],f,h;if(!e||"string"!=typeof e)return!1;if(d)f=[d];else for(h in c=a.peers,f=[],c)f.push(h);if(h=f.length){c=z();b=b.length?p.call(b,1):[];if(!a._transmit("exchange",d,{xid:c,idx:0,phrase:e,data:b}))return!1;for(;h--;)q(a,c,f[h]).push(e);return c}}function q(a,b,d){var c;g.call(a,"_ax")||(c=a._ax={xids:{},cbs:{}},a.on("::disconnect",w));b&&!g.call(a._ax.xids,b)&&(c=a._ax.xids[b]={pids:{},cnt:0});d&&!g.call(a._ax.xids[b].pids,d)&&(a._ax.xids[b].cnt++,
c=[],c.endFn=function(){return!!n(a,b,d)},c=a._ax.xids[b].pids[d]=c);return c}function w(){var a=this._ax.xids,b;this.off("::disconnect",w);for(b in a)r(this,b,a[b],1);delete this._ax}function r(a,b,d){var c,e,f;if(g.call(a,"_ax")&&(c=a._ax.xids,(e=c[b])&&g.call(e.pids,d)))return f=e.pids[d],delete e.pids[d],--e.cnt||delete c[b],a=a.peers[d],a._client.fire("::endExchange",a,f.concat()),1}function n(a,b,d){a._transmit("exchange",d,{xid:b,xkill:1});r(a,b,d)}var l=u||t?require("subetha"):v.Subetha,z=
l.guid,s=l.Client,x=l.Peer,p=Array.prototype.slice,g=Object.prototype.hasOwnProperty;s.prototype.adhoc=function(){var a=arguments,b=a[a.length-1];1<a.length&&"function"==typeof b&&(q(this),this._ax.cbs["="+p.call(a,0,-1).join()]=b);return this};s.prototype.unhoc=function(){var a,b;if(g.call(this,"_ax"))for(b in a=p.call(arguments),"function"==typeof a[a.length-1]&&(a=a.slice(0,-1)),a="="+a.join(),chainRxp=new y("^"+a),a=this._ax.cbs,a)chainRxp.test(b)&&delete a[b];return this};s.prototype.ask=function(){return k(this,
arguments)};x.prototype.ask=function(){return k(this._client,arguments,this.id)};x.prototype.endExchange=function(a){var b=this.id,d=this._client,c=this._ax,e=0,f=!a,h,g;if(c)for(g in c)if(h=g==a,f||h||c[g].chain[0]==a)if(n(d,b,g),e++,h)break;return e};Subetha.msgType.exchange=function(a,b,d,c){c=c.msg.data;var e=c.xid,f=b.id,h,k,m,l;g.call(a,"_ax")?g.call(c,"xkill")?r(a,e,f):(q(a,e,f),k=a._ax,b=c.phrase,h=c.idx,m=k.xids[e].pids[f],l="="+m.concat(b).join(),g.call(k.cbs,l)&&m.length==h?(m.push(b),
d.phrase=b,d.data=c.data,d.xid=e,d.end=m.endFn,d.reply=function(){var b,c;return g.call(k.xids,e)&&m.length==h+1?(b=arguments,c=b[0],m.push(c),b=p.call(b,1),a._transmit("exchange",f,{xid:e,idx:h+1,phrase:c,data:b})):!1},d.thread=m.concat(),a.fire("::exchange",d,a.peers[f]),g.call(k.cbs,l)?(cb=k.cbs[l],c.data.length?cb.apply(a,[d].concat(c.data)):cb.call(a,d)):n(a,e,f)):n(a,e,f)):n(a,e,f)};return l}t?define(k):u?module.exports=k():v.Subetha&&k()}("function"===typeof define,"undefined"!=typeof exports,
RegExp,this);