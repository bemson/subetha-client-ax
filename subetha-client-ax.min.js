/* SubEtha Ad Hoc-Exchange v0.0.2-alpha | github.com/bemson | (c) 2014, APACHE */
!function(v,w,k,B,x,E){function n(){function n(a){return a&&"string"===typeof a}function y(a,b,c){var e,d=b[0],g,f;if(!d||"string"!=typeof d)return!1;if(c)g=[c];else for(f in e=a.peers,g=[],e)g.push(f);if(f=g.length){e=C();b=b.length?r.call(b,1):[];if(!a._transmit("subetha/exchange",c,{xid:e,idx:0,phrase:d,data:b}))return!1;for(;f--;)s(a,e,g[f]).push(d);return e}}function s(a,b,c){var e,d;h.call(a,"_ax")||(e=a._ax={xids:{},cbs:{}},a.on("::disconnect",z));d=a._ax;b&&!h.call(d.xids,b)&&(e=d.xids[b]=
{pids:{},cnt:0});c&&!h.call(d.xids[b].pids,c)&&(d.xids[b].cnt++,e=[],e.endFn=function(){return!!p(a,b,c)},e=d.xids[b].pids[c]=e);return e}function z(){var a=this._ax.xids,b;this.off("::disconnect",z);for(b in a)t(this,b,a[b],1);delete this._ax}function t(a,b,c){var e,d,g;if(h.call(a,"_ax")&&(e=a._ax.xids,(d=e[b])&&h.call(d.pids,c)))return g=d.pids[c],delete d.pids[c],--d.cnt||delete e[b],a=a.peers[c],a._client.fire("::exchange-end",a,b,g.concat()),1}function p(a,b,c){a._transmit("subetha/exchange",
c,{xid:b,xkill:1});t(a,b,c)}var l=w||v?require("subetha"):x.Subetha,C=l.guid,u=l.Client,A=l.Peer,r=k.prototype.slice,h=Object.prototype.hasOwnProperty,D="function"===typeof k.isArray?k.isArray:function(a){return a instanceof k};u.prototype.adhoc=function(){var a=arguments,b=a[a.length-1];1<a.length&&"function"==typeof b&&(s(this),this._ax.cbs["="+r.call(a,0,-1).join()]=b);return this};u.prototype.unhoc=function(){var a,b;if(h.call(this,"_ax"))for(b in a=r.call(arguments),"function"==typeof a[a.length-
1]&&(a=a.slice(0,-1)),a="="+a.join(),chainRxp=new B("^"+a),a=this._ax.cbs,a)chainRxp.test(b)&&delete a[b];return this};u.prototype.ask=function(){return y(this,arguments)};A.prototype.ask=function(){return y(this._client,arguments,this.id)};A.prototype.endExchange=function(a){var b=this.id,c=this._client,e=this._ax,d=0,g=!a,f,h;if(e)for(h in e)if(f=h==a,g||f||e[h].chain[0]==a)if(p(c,b,h),d++,f)break;return d};Subetha.msgType["subetha/exchange"]=function(a,b,c,e){var d=b.id,g,f,k,q,m,l;"object"==typeof c&&
n(f=c.xid)&&(h.call(a,"_ax")?h.call(c,"xkill")?t(a,f,d):"number"==typeof(k=c.idx)&&n(l=c.phrase)&&D(g=c.data)?(s(a,f,d),q=a._ax,m=q.xids[f].pids[d],c="="+m.concat(l).join(),h.call(q.cbs,c)&&m.length==k?(m.push(l),b={end:m.endFn,reply:function(){var b,c;return h.call(q.xids,f)&&m.length==k+1?(b=arguments,c=b[0],m.push(c),b=r.call(b,1),a._transmit("subetha/exchange",d,{xid:f,idx:k+1,phrase:c,data:b})):!1},thread:m.concat(),data:g,id:e.id,peer:b,timeStamp:e.timeStamp,phrase:l,xid:f},cb=q.cbs[c],g.length?
cb.apply(a,[b].concat(g)):cb.call(a,b)):p(a,f,d)):p(a,f,d):p(a,f,d))};return l}v?define(n):w?module.exports=n():x.Subetha&&n()}("function"===typeof define,"undefined"!=typeof exports,Array,RegExp,this);